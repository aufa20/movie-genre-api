<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const supabaseUrl = 'https://cvsqzmoyqfvhwdxtvqhb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2c3F6bW95cWZ2aHdkeHR2cWhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzMTA2NzgsImV4cCI6MjA2NTg4NjY3OH0._SM-1bNPzYxAgHC1PjpcK1K_OEtCOaDyYBuQ68yIr38';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function predictGenre(desc) {
      const response = await fetch("http://localhost:5000/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description: desc })
      });

      if (!response.ok) {
        throw new Error("Flask API error");
      }

      const data = await response.json();
      return data.genre;
    }

    async function recommendMovies() {
      const desc = document.getElementById('description').value;
      if (!desc) return alert("Please enter a description.");

      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `<p>Processing...</p>`;

      try {
        const predictedGenre = await predictGenre(desc);
        resultDiv.innerHTML = `<p><strong>Predicted genre:</strong> ${predictedGenre}</p>`;

        const { data, error } = await supabase
          .from('movies')
          .select('*')
          .ilike('genre', `%${predictedGenre}%`);

        if (error) {
          resultDiv.innerHTML += `<p style="color:red;">Error: ${error.message}</p>`;
          return;
        }

        if (!data || data.length === 0) {
          resultDiv.innerHTML += `<p>No movies found for this genre.</p>`;
          return;
        }

        data.forEach(movie => {
          resultDiv.innerHTML += `
            <div class="movie">
              <strong>${movie.title}</strong><br/>
              ${movie.description}<br/>
              <em>Genre: ${movie.genre}</em>
            </div>`;
        });
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    }

    document.getElementById('recommendBtn').addEventListener('click', recommendMovies);
  });
</script>
