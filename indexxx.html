<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const supabaseUrl = 'https://cvsqzmoyqfvhwdxtvqhb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJI...'; // your full key
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function predictGenre(desc) {
      const response = await fetch("http://localhost:5000/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description: desc })
      });

      if (!response.ok) {
        throw new Error("Flask API error");
      }

      const data = await response.json();
      console.log("Predicted genre:", data.genre);  // ðŸ‘ˆ debug log
      return data.genre;
    }

    async function recommendMovies() {
      const desc = document.getElementById('description').value;
      const resultDiv = document.getElementById('result');
      if (!desc) return alert("Please enter a movie description.");

      resultDiv.innerHTML = `<p>Predicting genre...</p>`;

      try {
        const predictedGenre = await predictGenre(desc);
        resultDiv.innerHTML = `<p><strong>Predicted genre:</strong> ${predictedGenre}</p>`;

        const { data, error } = await supabase
          .from('movies')
          .select('*')
          .ilike('genre', `%${predictedGenre}%`);

        if (error) {
          resultDiv.innerHTML += `<p style="color:red;">Error: ${error.message}</p>`;
          return;
        }

        if (!data || data.length === 0) {
          resultDiv.innerHTML += `<p>No movies found in Supabase for this genre.</p>`;
          return;
        }

        data.forEach(movie => {
          resultDiv.innerHTML += `
            <div class="movie">
              <strong>${movie.title}</strong><br/>
              ${movie.description}<br/>
              <em>Genre: ${movie.genre}</em>
            </div>`;
        });
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">${err.message}</p>`;
        console.error("Error:", err);
      }
    }

    document.getElementById('recommendBtn').addEventListener('click', recommendMovies);
  });
</script>
